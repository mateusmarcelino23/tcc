<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Empréstimo</title>
    <link rel="icon" href="../imagens/1748908346791.png" type="image/x-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="../estilos/style.css">
    <link rel="stylesheet" href="../estilos/registrar.css">
</head>

<body>
    <!-- Cabeçalho -->
    <nav class="header">
        <a href="painel.html" class="header-link">
            <img src="../imagens/1748908346791.png" alt="Logo" class="header-logo" />
            <span class="header-text">Biblioteca M.V.C </span>
        </a>
        <span id="toggleSidebar" class="openbtn" onclick="toggleNav()">&#9776;</span>
    </nav>

    <!-- Menu lateral -->
    <div class="sidebar" id="mySidebar">
        <ul>
            <li><a href="relatorios.html">Relatórios</a></li>
            <li><a href="../backend/logout.php" id="logoutLink">Logout</a></li>
        </ul>
    </div>

    <div class="mt-3 text-start">
        <a href="ver_emprestimos.html" class="link-back">&lt; Voltar</a>
    </div>

    <!-- Mensagem de feedback -->
    <div class="mensagem" id="mensagem"></div>

    <div class="container mt-4">
        <h2 class="text-center">Editar Empréstimo</h2>
        <form id="editarForm">
            <!-- Campo Aluno -->
            <div class="mb-3">
                <label for="id_aluno" class="form-label">Aluno:</label>
                <select name="id_aluno" id="id_aluno" class="form-select" required></select>
            </div>

            <!-- Campo Livro -->
            <div class="mb-3">
                <label for="id_livro" class="form-label">Livro:</label>
                <select name="id_livro" id="id_livro" class="form-select" required></select>
            </div>

            <!-- Datas -->
            <div class="mb-3">
                <label for="data_emprestimo" class="form-label">Data de Retirada:</label>
                <input type="text" name="data_emprestimo" id="data_emprestimo" class="form-control" required>
            </div>

            <div class="mb-3">
                <label for="data_devolucao" class="form-label">Data de Devolução:</label>
                <input type="text" name="data_devolucao" id="data_devolucao" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-gradient w-100">Atualizar Empréstimo</button>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const idEmprestimo = urlParams.get('id');

        // Função para converter data BR para Y-m-d
        function converterDataParaBD(data) {
            const [dia, mes, ano] = data.split('/');
            return `${ano}-${mes}-${dia}`;
        }

        // Inicializa Select2 com AJAX
        function initSelect2(selector, url, placeholderText) {
            $(selector).select2({
                placeholder: placeholderText,
                ajax: {
                    url: url,
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            term: params.term
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1,
                language: {
                    noResults: () => "Nenhum resultado encontrado"
                }
            });
        }

        $(document).ready(function() {
            initSelect2('#id_aluno', '../backend/buscar_alunos.php', 'Digite o nome do aluno');
            initSelect2('#id_livro', '../backend/buscar_livros.php', 'Digite o nome do livro');

            flatpickr("#data_emprestimo", {
                dateFormat: "d/m/Y",
                locale: "pt"
            });
            flatpickr("#data_devolucao", {
                dateFormat: "d/m/Y",
                locale: "pt"
            });

            // Carrega dados do empréstimo via API
            $.getJSON(`../backend/editar_emprestimo.php?id=${idEmprestimo}`, function(response) {
                if (response.success) {
                    const e = response.data;
                    // Set campos select
                    const alunoOption = new Option(e.aluno_nome, e.id_aluno, true, true);
                    $('#id_aluno').append(alunoOption).trigger('change');

                    const livroOption = new Option(e.nome_livro, e.id_livro, true, true);
                    $('#id_livro').append(livroOption).trigger('change');

                    $('#data_emprestimo').val(e.data_emprestimo.split('-').reverse().join('/'));
                    $('#data_devolucao').val(e.data_devolucao.split('-').reverse().join('/'));
                } else {
                    $('#mensagem').html(`<p style="color:red;">${response.message}</p>`);
                }
            });

            // Submissão via AJAX
            $('#editarForm').on('submit', function(e) {
                e.preventDefault();

                const dataEmprestimoStr = $('#data_emprestimo').val();
                const dataDevolucaoStr = $('#data_devolucao').val();

                const [diaEmp, mesEmp, anoEmp] = dataEmprestimoStr.split('/');
                const [diaDev, mesDev, anoDev] = dataDevolucaoStr.split('/');

                const dataEmprestimo = new Date(`${anoEmp}-${mesEmp}-${diaEmp}`);
                const dataDevolucao = new Date(`${anoDev}-${mesDev}-${diaDev}`);

                if (dataDevolucao < dataEmprestimo) {
                    alert("A data de devolução não pode ser anterior à data de retirada.");
                    return;
                }

                $.post(`../backend/editar_emprestimo.php?id=${idEmprestimo}`, {
                    id_aluno: $('#id_aluno').val(),
                    id_livro: $('#id_livro').val(),
                    data_emprestimo: dataEmprestimoStr,
                    data_devolucao: dataDevolucaoStr
                }, function(resp) {
                    const response = typeof resp === 'string' ? JSON.parse(resp) : resp;

                    // Atualiza a mensagem e dispara animação
                    const mensagemDiv = document.querySelector('.mensagem');
                    mensagemDiv.style.opacity = '1';
                    mensagemDiv.style.display = 'block';
                    mensagemDiv.innerHTML = `<p style="color:${response.success ? 'green' : 'red'};">${response.message}</p>`;

                    // Garante que a animação do seu script.js funcione
                    setTimeout(function() {
                        mensagemDiv.style.opacity = '0';
                        setTimeout(function() {
                            mensagemDiv.style.display = 'none';
                        }, 500);
                    }, 3000);
                });
            });
        });
    </script>

    <!-- Link para arquivos JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../interatividade/checar_sessao.js"></script>
    <script src="../interatividade/script.js"></script>
    <script src="../interatividade/devtools_block.js"></script>
    <script src="../interatividade/logout.js"></script>
</body>

</html>