<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Registrar Empréstimo</title>
    <link rel="icon" href="../imagens/1748908346791.png" type="image/x-icon">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" type="text/css" href="../estilos/style.css">
    <link rel="stylesheet" type="text/css" href="../estilos/registrar.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
    <!-- Cabeçalho -->
    <nav class="header">
        <a href="painel.html" class="header-link">
            <img src="../imagens/1748908346791.png" alt="Logo" class="header-logo" />
            <span class="header-text">Biblioteca M.V.C </span>
        </a>
        <span id="toggleSidebar" class="openbtn" onclick="toggleNav()">&#9776;</span>
    </nav>

    <!-- Menu lateral -->
    <div class="sidebar" id="mySidebar">
        <ul>
            <li><a href="relatorios.html">Relatórios</a></li>
            <li><a href="../backend/logout.php" id="logoutLink">Logout</a></li>
        </ul>
    </div>

    <div class="mt-3 text-start">
        <a href="ver_emprestimos.html" class="btn-back" title="Voltar">
            &#8592;
        </a>
    </div>

    <!-- Mensagem de feedback -->
    <div class="mensagem" id="mensagem"></div>

    <div class="container">
        <h2 class="text-center">Registrar Empréstimo</h2>
        <form id="emprestimoForm">

            <div class="mb-3">
                <label for="id_aluno" class="form-label">Aluno:</label>
                <select id="id_aluno" class="form-select" required></select>
            </div>

            <div class="mb-3">
                <label for="id_livro" class="form-label">Livro:</label>
                <select id="id_livro" class="form-select" required></select>
            </div>

            <div class="mb-3">
                <label for="data_emprestimo" class="form-label">Data de Retirada:</label>
                <input type="text" id="data_emprestimo" class="form-control" required>
            </div>

            <div class="mb-3">
                <label for="data_devolucao" class="form-label">Data de Devolução:</label>
                <input type="text" id="data_devolucao" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-gradient w-100">Registrar Empréstimo</button>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        $(document).ready(function() {
            function initSelect2(selector, url, placeholderText) {
                $(selector).select2({
                    placeholder: placeholderText,
                    ajax: {
                        url: url,
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                term: params.term
                            };
                        },
                        processResults: function(data) {
                            return {
                                results: data
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 1,
                    language: {
                        noResults: function() {
                            return "Nenhum resultado encontrado";
                        }
                    }
                });
            }

            initSelect2('#id_aluno', '../backend/buscar_alunos.php', 'Digite o nome do aluno');
            initSelect2('#id_livro', '../backend/buscar_livros.php', 'Digite o nome do livro');

            flatpickr("#data_emprestimo", {
                allowInput: false,
                locale: 'pt',
                dateFormat: 'd/m/Y'
            });
            flatpickr("#data_devolucao", {
                allowInput: false,
                locale: 'pt',
                dateFormat: 'd/m/Y'
            });

            $('#emprestimoForm').on('submit', function(e) {
                e.preventDefault();

                const dataEmprestimoStr = $('#data_emprestimo').val();
                const dataDevolucaoStr = $('#data_devolucao').val();
                const [diaEmp, mesEmp, anoEmp] = dataEmprestimoStr.split('/');
                const [diaDev, mesDev, anoDev] = dataDevolucaoStr.split('/');
                const dataEmprestimo = new Date(`${anoEmp}-${mesEmp}-${diaEmp}`);
                const dataDevolucao = new Date(`${anoDev}-${mesDev}-${diaDev}`);

                if (dataDevolucao < dataEmprestimo) {
                    alert("A data de devolução não pode ser anterior à data de retirada.");
                    return;
                }

                // Preparar dados para enviar
                const formData = new FormData();
                formData.append('id_aluno', $('#id_aluno').val());
                formData.append('id_livro', $('#id_livro').val());
                formData.append('data_emprestimo', dataEmprestimoStr);
                formData.append('data_devolucao', dataDevolucaoStr);

                fetch('../backend/registrar_emprestimo.php', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const mensagemDiv = document.getElementById('mensagem');
                        mensagemDiv.innerHTML = `<p style="color: ${data.success ? 'green' : 'red'};">${data.message}</p>`;

                        mensagemDiv.style.opacity = '1';
                        mensagemDiv.style.display = 'block';
                        setTimeout(() => {
                            mensagemDiv.style.transition = 'opacity 0.5s';
                            mensagemDiv.style.opacity = '0';
                            setTimeout(() => {
                                mensagemDiv.style.display = 'none';
                            }, 500);
                        }, 3000);

                        if (data.success) {
                            // Limpar formulário após sucesso
                            $('#emprestimoForm')[0].reset();
                            $('#id_aluno').val(null).trigger('change');
                            $('#id_livro').val(null).trigger('change');
                        }
                    })

            });
        });
    </script>

    <!-- Funções extras -->
    <script src="../interatividade/checar_sessao.js"></script>
    <script src="../interatividade/script.js"></script>
    <script src="../interatividade/devtools_block.js"></script>
    <script src="../interatividade/logout.js"></script>
</body>

</html>