<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Editar Professor</title>
    <link rel="icon" href="../imagens/1748908346791.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../estilos/style.css">
    <link rel="stylesheet" type="text/css" href="../estilos/registrar.css">
</head>

<body>
    <!-- Cabeçalho -->
    <nav class="header">
        <a href="painel.html" class="header-link">
            <img src="../imagens/1748908346791.png" alt="Logo" class="header-logo" />
            <span class="header-text">Biblioteca M.V.C</span>
        </a>
        <span id="toggleSidebar" class="openbtn" onclick="toggleNav()">&#9776;</span>
    </nav>

    <!-- Menu lateral -->
    <div class="sidebar" id="mySidebar">
        <ul>
            <li><a href="relatorios.html">Relatórios</a></li>
            <li><a href="../backend/logout.php" id="logoutLink">Logout</a></li>
        </ul>
    </div>

    <a href="ver_professores.html" class="link-back">
        < Voltar</a>

            <div class="mensagem" id="mensagem"></div>

            <div class="container">
                <h2 class="text-center">Editar Professor</h2>
                <form id="editarForm" novalidate>
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome e Sobrenome:</label>
                        <input type="text" name="nome" id="nome" class="form-control" required autocomplete="off">
                    </div>

                    <div class="mb-3">
                        <label for="cpf" class="form-label">CPF:</label>
                        <input type="text" name="cpf" id="cpf" class="form-control" autocomplete="off" required
                            pattern="\d{3}\.\d{3}\.\d{3}-\d{2}" placeholder="000.000.000-00">
                        <div class="invalid-feedback">Informe um CPF válido no formato 000.000.000-00.</div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email:</label>
                        <input type="email" name="email" id="email" class="form-control" required autocomplete="off">
                    </div>

                    <div class="mb-3">
                        <label for="senha" class="form-label">Nova Senha (opcional):</label>
                        <input type="text" name="senha" id="senha" class="form-control" autocomplete="off"
                            pattern="[a-z0-9]{8,16}" minlength="8" maxlength="16"
                            title="A senha deve conter apenas letras minúsculas e números, entre 8 e 16 caracteres.">
                        <div class="invalid-feedback">Use apenas letras minúsculas e números (8-16 caracteres).</div>
                    </div>

                    <button type="submit" class="btn btn-gradient w-100">Salvar Alterações</button>
                </form>
            </div>

    <script>
        const professorId = new URLSearchParams(window.location.search).get('id');
        const mensagemDiv = document.querySelector('.mensagem');

        // Função para mostrar mensagens temporárias
        function showMessage(message, success = true) {
            mensagemDiv.innerHTML = `<p style="color:${success ? 'green' : 'red'}">${message}</p>`;
            mensagemDiv.style.opacity = '1';
            mensagemDiv.style.display = 'block';

            setTimeout(() => {
                mensagemDiv.style.opacity = '0';
                setTimeout(() => {
                    mensagemDiv.style.display = 'none';
                }, 500); // tempo do fade-out
            }, 3000); // tempo visível
        }

        // Formatar CPF enquanto digita
        document.getElementById('cpf').addEventListener('input', function () {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            this.value = value;
        });

        // Carrega os dados do professor via AJAX
        async function carregarProfessor() {
            try {
                const response = await fetch(`../backend/editar_professor.php?id=${professorId}`);
                const data = await response.json();

                if (data.status !== 'success') {
                    showMessage(data.message, false);
                    return;
                }

                const prof = data.data;
                document.getElementById('nome').value = prof.nome;
                document.getElementById('cpf').value = prof.cpf.replace(
                    /(\d{3})(\d{3})(\d{3})(\d{2})/,
                    '$1.$2.$3-$4'
                );
                document.getElementById('email').value = prof.email;
            } catch (error) {
                showMessage('Erro ao carregar dados do professor.', false);
                console.error(error);
            }
        }

        // Submissão do formulário via AJAX
        document.getElementById('editarForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`../backend/editar_professor.php?id=${professorId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                showMessage(data.message, data.status === 'success');
            } catch (error) {
                showMessage('Erro ao atualizar professor.', false);
                console.error(error);
            }
        });

        // Inicializa
        carregarProfessor();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../interatividade/script.js"></script>
    <script src="../interatividade/devtools_block.js"></script>
    <script src="../interatividade/logout.js"></script>

</body>

</html>