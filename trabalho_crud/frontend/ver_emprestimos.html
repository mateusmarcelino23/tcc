<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Empréstimos</title>
    <link rel="icon" href="../imagens/1748908346791.png" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <!-- CSS personalizado -->
    <link rel="stylesheet" type="text/css" href="../estilos/style.css">
    <link rel="stylesheet" href="../estilos/ver.css">
</head>

<body>

    <div class="mt-3 text-start">
        <a href="painel.html" class="link-back">&lt; Voltar para o painel</a>
    </div>

    <nav class="header">
        <a href="painel.html" class="header-link">
            <img src="../imagens/1748908346791.png" alt="Logo" class="header-logo" />
            <span class="header-text">Biblioteca M.V.C </span>
        </a>
        <span id="toggleSidebar" class="openbtn" onclick="toggleNav()">&#9776;</span>
    </nav>

    <!-- Menu lateral -->
    <div class="sidebar" id="mySidebar">
        <ul>
            <li><a href="relatorios.html">Relatórios</a></li>
            <li><a href="../backend/logout.php" id="logoutLink">Logout</a></li>
        </ul>
    </div>

    <a href="registrar_emprestimo.html" class="link-registrar">Registrar Empréstimo</a>

    <div class="container">
        <h2 class="text-center">Lista de Empréstimos</h2>

        <div class="table-container">
            <table id="emprestimosTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Aluno</th>
                        <th>Livro</th>
                        <th>Retirada</th>
                        <th>Devolução</th>
                        <th>Professor</th>
                        <th>Status</th>
                        <th></th> <!-- Confirmar devolução ou cancelar -->
                        <th></th> <!-- Editar -->
                        <th></th> <!-- Remover -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Conteúdo será carregado via AJAX -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <!-- Inicializa DataTables com AJAX e idioma PT-BR -->
    <script>
        $(document).ready(function () {
            $('#emprestimosTable').DataTable({
                rowId: 'id',
                ajax: {
                    url: '../backend/ver_emprestimos.php',
                    dataSrc: 'data'
                },
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json'
                },
                columns: [
                    { data: 'aluno_nome' },
                    { data: 'nome_livro' },
                    {
                        data: 'data_emprestimo',
                        render: function (data) {
                            const dt = new Date(data);
                            return dt.toLocaleDateString('pt-BR');
                        }
                    },
                    {
                        data: 'data_devolucao',
                        render: function (data) {
                            if (!data || data === '0000-00-00') return '-';
                            const dt = new Date(data);
                            return dt.toLocaleDateString('pt-BR');
                        }
                    },
                    { data: 'professor_nome' },
                    {
                        data: null,
                        render: function (data) {
                            const hoje = new Date();
                            let status = '';
                            let classe = '';

                            if (data.status == 2) {
                                status = 'Devolvido';
                                classe = 'status-devolvido';
                            } else if (data.status == 1 || new Date(data.data_devolucao) <= hoje) {
                                status = 'Pendente';
                                classe = 'status-atrasado';
                            } else {
                                status = 'Em andamento';
                                classe = 'status-andamento';
                            }
                            return `<span class="badge ${classe}">${status}</span>`;
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            const devolvido = data.status == 2;
                            return `<button class="status-entregue" data-devolvido="${devolvido}" onclick="toggleDevolucao(this, ${data.id})">${devolvido ? 'Cancelar devolução' : 'Confirmar devolução'}</button>`;
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `<button class="edit-link" onclick="location.href='editar_emprestimo.html?id=${data.id}'">Editar</button>`;
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `<a href="?remover=${data.id}" class="delete-link" onclick="return confirm('Tem certeza de que deseja remover este empréstimo?')">Remover</a>`;
                        }
                    }
                ]
            });
        });
    </script>

    <!-- Funções extras -->
    <script src="../interatividade/script.js"></script>
    <script src="../interatividade/devtools_block.js"></script>
    <script src="../interatividade/logout.js"></script>
    <script src="../interatividade/tabelaemprestimos.js"></script>

</body>

</html>